@{
    ViewBag.Title = "Index";
    int sessionId = 1;
    //var listSession = Model.Sessions;
    //sessionId = Model.Sessions.FirstOrDefault().SessionID;
    //var votingItemList = Model.Votings;
    //var qaItemList = Model.QAs;
    int[] listSessionsId = new int[Model.Count()];
    for (int index = 0; index < Model.Count(); index++)
    {
        listSessionsId[index] = Model.ElementAt(index).SessionID;
    }
    int eventId = ViewBag.EventId;
    string curPath = Request.Url.GetLeftPart(UriPartial.Authority) + Request.ApplicationPath;

    var listQa = ViewBag.ListQA;
    var listVoting = ViewBag.ListVoting;


}
@using HmsService.ViewModels;
@model IEnumerable<SessionViewModel>
<div class="container">
    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <div class="row">
                <h2 class="col-sm-10">Quản Lý Tương Tác</h2>
                <div class="col-sm-2">
                    <button class="btn btn-primary" type="submit" data-toggle="modal" data-target="#addInteractionModal" style="margin-top:20px">
                        <i class="fa fa-plus" style="margin-right:7px" aria-hidden="true"></i>Thêm
                    </button>
                </div>
            </div>
            <div class="modal fade" id="addInteractionModal" role="dialog">
                <div class="modal-dialog">

                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Thêm Tương Tác</h4>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="col-sm-3 form-control-label">
                                    Tên<span class="required">*</span>
                                </label>
                                <div class="col-sm-9 input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-briefcase" aria-hidden="true"></i>
                                    </div>
                                    <input type="text" id="newName" class="form-control" placeholder="Enter Interaction's name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 form-control-label">
                                    Lựa chọn Tương tác
                                    <span class="required">*</span>
                                </label>
                                <div class="input-group col-sm-9">
                                    <div class="input-group-addon">
                                        <i class="fa fa-comments" aria-hidden="true"></i>
                                    </div>
                                    <select id="InteractionSelectBox" class="form-control">
                                        <option>---Chọn---</option>
                                        <option value="1">Bỏ Phiếu</option>
                                        <option value="2">Hỏi Đáp</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-3 form-control-label">
                                    Loại Tương tác
                                    <span class="required">*</span>
                                </label>
                                <div class="input-group col-sm-9">
                                    <div class="input-group-addon">
                                        <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                    </div>
                                    <select Id="KindOfInteractionSelectBox" class="form-control">
                                        <option>---Chọn---</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="btn-add" class="btn btn-primary" data-dismiss="modal" style="margin-top:5px">Thêm</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="ibox-content">
            <!-- Custom Tabs -->
            <div class="nav-tabs-custom">
                <ul class="nav nav-tabs">
                    @{
                        int i = 0;
                        foreach (var item in Model)
                        {
                            <li class="@(i == 0 ? "active" : "")" onclick="InitDatatable(@(i), @item.SessionID); ChangeTabIndex(@(i), @item.SessionID)"><a href="#tab_@(i)" data-toggle="tab">@Html.Raw(item.Name)</a></li>
                            i++;
                        }
                    }
                </ul>
            </div>
            <!--Tab content-->
            <div class="tab-content" style="display:flex;">
                @{
                    int j = 0;
                    foreach (var item in Model)
                    {
                        <div class="tab-pane @(j == 0 ? "active" : "")" id="tab_@(j)" style="width:100%;">
                            <div class="col-sm-6 col-md-6 col-lg-6">
                                <div class="tableHeadText" style="text-align:center; margin-bottom:10px; border-bottom:1px solid">Hiện có</div>
                                <table class="table table-hover table-bordered" id="tblInteraction@(j)">
                                    <thead>
                                        <tr>
                                            <th>Tên</th>
                                            <th>Tên loại khảo sát/ hỏi đáp</th>
                                            <th>Loại</th>
                                            <th>Chức Năng</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                            <div class="col-sm-6 col-md-6 col-lg-6">
                                <div class="tableHeadText" style="text-align:center; margin-bottom:10px; border-bottom:1px solid">Đang Chạy</div>
                                <table class="table table-hover table-bordered" id="tblInteractionRunning@(j)">
                                    <thead>
                                        <tr>
                                            <th>Tên</th>
                                            <th>Loại</th>
                                            <th>Chức Năng</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                        j++;
                    }
                }
                <!-- /.tab-pane -->
            </div>

        </div>

    </div>
    <div class="modal fade" id="deleteModal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="modal-title">Bạn có chắc chắn?</h2>
                </div>
                <div class="modal-body">
                    <h3 class="interaction-del-title"></h3>
                </div>
                <div class="modal-footer">
                    <button id="btn-del" type="button" class="btn btn-default interaction-del-id" @*data-dismiss="modal"*@>Xóa</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="stopModal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="modal-title">Bạn có chắc chắn?</h2>
                </div>
                <div class="modal-body">
                    <h3 class="interaction-stop-title"></h3>
                </div>
                <div class="modal-footer">
                    <button id="btn-stop" type="button" class="btn btn-default interaction-stop-id" data-dismiss="modal">Dừng</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="playModal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="modal-title">Bạn có chắc chắn?</h2>
                </div>
                <div class="modal-body">
                    <h3 class="interaction-play-title"></h3>
                </div>
                <div class="modal-footer">
                    <button id="btn-play" type="button" class="btn btn-default interaction-play-id" data-dismiss="modal">Chạy</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="editInteractionModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Chỉnh Sửa Tương Tác</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="col-sm-3 form-control-label">
                            Tên<span class="required">*</span>
                        </label>
                        <div class="col-sm-9 input-group">
                            <div class="input-group-addon">
                                <i class="fa fa-briefcase" aria-hidden="true"></i>
                            </div>
                            <input type="text" class="form-control interaction-name" placeholder="Enter Interaction's name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 form-control-label">
                            Chọn Tương tác
                            <span class="required">*</span>
                        </label>
                        <div class="input-group col-sm-9">
                            <div class="input-group-addon">
                                <i class="fa fa-comments" aria-hidden="true"></i>
                            </div>
                            <select id="InteractionEditSelectBox" class="form-control">
                                <option>---Chọn---</option>
                                <option value="1">Bỏ Phiếu</option>
                                <option value="2">Hỏi Đáp</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 form-control-label">
                            Kind Interaction
                            <span class="required">*</span>
                        </label>
                        <div class="input-group col-sm-9">
                            <div class="input-group-addon">
                                <i class="fa fa-check-square-o" aria-hidden="true"></i>
                            </div>
                            <select Id="KindOfInteractionEditSelectBox" class="form-control">
                                <option>---Chọn---</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btn-save" class="btn btn-primary interaction-id" data-dismiss="modal" style="margin-top:5px">Lưu</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                </div>
            </div>

        </div>
    </div>

</div>

<input type="hidden" id="tab-index" value="0" />
<input type="hidden" id="session-id" value="@(sessionId)" />

@section scripts {
    <script>
        var urlApi = '@curPath';
        var eventId = @eventId;
        var listQA = @Html.Raw(Json.Encode(listQa));
        var listVoting = @Html.Raw(Json.Encode(listVoting));

        function editInteractionModal(id, name, votingId, qaId) {
            $('.interaction-name').val(name);
            if (votingId != 'null') {
                InitVotingSelectBoxInModalUpdate();
                $('#InteractionEditSelectBox').val(1);
                $('#KindOfInteractionEditSelectBox').val(votingId);
            }
            else if (qaId != 'null') {
                InitQASelectBoxInModalUpdate();
                $('#InteractionEditSelectBox').val(2);
                $('#KindOfInteractionEditSelectBox').val(qaId);
            }
            $('.interaction-id').val(id);

        }


        function stopInteraction(id, name) {
            $('.interaction-stop-id').val(id);
            $('.interaction-stop-title').html("Stop Interaction " + name);
        }


        function delInteraction(id, name) {
            $('.interaction-del-id').val(id);
            //$('.interaction-del-title').html("Delete Interaction " + name);
        }


        function playInteraction(id, name) {
            $('.interaction-play-id').val(id);
        }


        $(document).ready(function () {
            var listSessions = @Html.Raw(Json.Encode(listSessionsId));
            if (listSessions != null) {
                InitDatatable(0, listSessions[0]);
            }
            else {
                InitDatatable(0, 0);
            }





            $('#InteractionEditSelectBox').on('click', function () {
                var SelectValue = $('#InteractionEditSelectBox').find(":selected").val();
                if (SelectValue == 1) {
                    $('#KindOfInteractionEditSelectBox').empty();
                    $('#KindOfInteractionEditSelectBox').append("<option>---Choose---</option>");
                    for (var i = 0; i < listVoting.length; i++) {
                        $('#KindOfInteractionEditSelectBox').append('<option value="' + listVoting[i].VotingId + '">' + listVoting[i].VotingName +'</option>');
                    }

                } else if (SelectValue == 2) {
                    $('#KindOfInteractionEditSelectBox').empty();
                    $('#KindOfInteractionEditSelectBox').append("<option>---Choose---</option>");
                    for (var i = 0; i < listQA.length; i++) {
                        $('#KindOfInteractionEditSelectBox').append('<option value="' + listQA[i].QAId + '">' + listQA[i].QAName +'</option>');
                    }
                } else {
                    $('#KindOfInteractionEditSelectBox').empty();
                    $('#KindOfInteractionEditSelectBox').append("<option>---Choose---</option>");
                }
            });

            $('#InteractionSelectBox').on('click', function () {
                var SelectValue = $('#InteractionSelectBox').find(":selected").val();
                if (SelectValue == 1) {
                    $('#KindOfInteractionSelectBox').empty();
                    $('#KindOfInteractionSelectBox').append("<option>---Choose---</option>");
                    for (var i = 0; i < listVoting.length; i++) {
                        $('#KindOfInteractionSelectBox').append('<option value="' + listVoting[i].VotingId + '">' + listVoting[i].VotingName +'</option>');
                    }

                } else if (SelectValue == 2) {
                    $('#KindOfInteractionSelectBox').empty();
                    $('#KindOfInteractionSelectBox').append("<option>---Choose---</option>");
                    for (var i = 0; i < listQA.length; i++) {
                        $('#KindOfInteractionSelectBox').append('<option value="' + listQA[i].QAId + '">' + listQA[i].QAName +'</option>');
                    }
                } else {
                    $('#KindOfInteractionSelectBox').empty();
                    $('#KindOfInteractionSelectBox').append("<option>---Choose---</option>");
                }
            });

        });


        function InitDatatable(index, sessionId) {
            $('#tblInteraction' + index).DataTable({
                ajax: {
                    url: urlApi + "/api/interaction/getAllInteractionNotRunning/" + sessionId,
                    dataSrc: ""
                },
                "bDestroy": true,
                columns: [
                    {
                        name: "Name",
                        render: function (data, type, row) {
                            return row.interactionName;
                        }
                    },
                    {
                        name: "NameOfInteraction",
                        render: function (data, type, row) {
                            if (row.voting != null) {
                                return row.voting.votingName;
                            }
                            else {
                                return row.qa.qaName;
                            }
                            
                        }
                    },
                    {
                        name: "Type",
                        render: function (data, type, row) {
                            if (row.votingId != null) {
                                return '<p>Voting<p/>';
                            } else if (row.qaId != null) {
                                return '<p>QA<p/>';
                            }
                        }
                    },
                    {
                        name: "Function",
                        render: function (data, type, row) {
                            return '<button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editInteractionModal" onclick="editInteractionModal(' + row.interactionId + ',\'' + row.interactionName + '\', \'' + row.votingId + '\', \'' + row.qaId + '\')"><i class="fa fa-pencil"></i></button>     ' +
                                '<button class="btn btn-danger btn-sm speaker-id" onclick="delInteraction(' + row.interactionId + ')"><i class="fa fa-trash"></i></button>       ' +
                                '<button class="btn btn-success btn-sm speaker-id" onclick="playInteraction(' + row.interactionId + ')"><i class="fa fa-play" aria-hidden="true"></i></button>';
                        }
                    }
                ]
            });

            $('#tblInteractionRunning' + index).DataTable({
                ajax: {
                    url: urlApi + "/api/interaction/getIsRunningInteraction/" + sessionId,
                    dataSrc: ""
                },
                "bDestroy": true,
                columns: [
                    {
                        name: "Name",
                        render: function (data, type, row) {
                            return row.interactionName;
                        }
                    },
                    {
                        name: "Type",
                        render: function (data, type, row) {
                            if (row.votingId != null) {
                                return '<p>Voting<p/>';
                            } else if (row.qaId != null) {
                                return '<p>QA<p/>';
                            }
                        }
                    },
                    {
                        name: "Function",
                        render: function (data, type, row) {
                            return '<button class="btn btn-danger btn-sm" onclick="stopInteraction(' + row.interactionId + ')"><i class="fa fa-stop" aria-hidden="true"></i></button>';
                        }
                    }
                ]
            });
        }


        function ChangeTabIndex(index, sessionId) {
            $('#tab-index').val(index);
            $('#session-id').val(sessionId);

        }

        function InitQASelectBoxInModalUpdate() {
            $('#KindOfInteractionEditSelectBox').empty();
            $('#KindOfInteractionEditSelectBox').append("<option>---Choose---</option>");
            for (var i = 0; i < listQA.length; i++) {
                $('#KindOfInteractionEditSelectBox').append('<option value="' + listQA[i].QAId + '">' + listQA[i].QAName + '</option>');
            }
        }

        function InitVotingSelectBoxInModalUpdate() {
            $('#KindOfInteractionEditSelectBox').empty();
            $('#KindOfInteractionEditSelectBox').append("<option>---Choose---</option>");
            for (var i = 0; i < listVoting.length; i++) {
                $('#KindOfInteractionEditSelectBox').append('<option value="' + listVoting[i].VotingId + '">' + listVoting[i].VotingName + '</option>');
            }
        }

        function delInteraction(interactionId) {
            swal({
                title: "Bạn có chắc không?",
                text: "Bạn muốn xóa tương tác này!",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn-danger",
                confirmButtonText: "Có!",
                cancelButtonText: "Không!",
                closeOnConfirm: false
            }, function () {
                $.ajax({
                    url: urlApi + '/api/interaction/DeleteInteraction',
                    method: "POST",
                    data: {
                        InteractionId: interactionId,
                    },
                    success: function (data) {
                        var index = $('#tab-index').val();
                        $('#tblInteraction' + index).DataTable().ajax.reload();
                        swal("Thành công!", "Xóa tương tác thành công", "success");
                    },
                    error: function (data) {
                        console.log(data);
                    }
                });

            });
        }


        function playInteraction(interactionId) {
            var sessionId = $('#session-id').val();
            $.ajax({
                url: urlApi + '/api/interaction/PlayInteraction',
                method: "POST",
                data: {
                    InteractionId: interactionId,
                    SessionId: sessionId,
                },
                success: function (data) {
                    var index = $('#tab-index').val();
                    $('#tblInteraction' + index).DataTable().ajax.reload();
                    $('#tblInteractionRunning' + index).DataTable().ajax.reload();
                    swal("Thành công!", "Tiến hành chạy tương tác thành công", "success");
                },
                error: function (data) {
                    console.log(data);
                }
            });
        }

        function stopInteraction(interactionId) {
            $.ajax({
                url: urlApi + '/api/interaction/StopInteraction',
                method: "POST",
                data: {
                    InteractionId: interactionId,
                },
                success: function (data) {
                    var index = $('#tab-index').val();
                    $('#tblInteraction' + index).DataTable().ajax.reload();
                    $('#tblInteractionRunning' + index).DataTable().ajax.reload();
                    swal("Thành công!", "Tắt chạy tương tác thành công", "success");
                },
                error: function (data) {
                    console.log(data);
                }
            });
        }

    </script>
}
<script src="~/Content/Interaction/Interaction.js"></script>
